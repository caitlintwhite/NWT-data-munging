---
title: "Alpine dry meadow fertilization results"
author: "CTW"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
  word_document: default
---

```{r setup, include=FALSE, warning = F, message = F, echo = F, }
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F)
# note: this script copies over script worked out in other R scripts for the sole purpose of exporting statistical results, tables and figures for Tim Seastedt (to avoid exporting a bunch of figs and tables as CVSs from R)
# see R scripts replicat_ts_results.R, analyze_ts_dats.R, and addnuts_figs.R for lengthier scripts that go through the analysis weeds
# addnuts_figs.R contains figure generation for NWT poster for self-study (ms contains slightly different NMDS figs [earlier versions])

## >> FIGS FOR SUBMISSION NEED TO BE **AT MIN** 300 DPI AND .TIF

# setup environment
library(tidyverse)
library(vegan)
library(knitr)
library(DescTools) # to test greyscale color printing
source("edi_functions.R")
na_vals <- c("", " ", NA, "NA", "NaN", NaN, ".")
options(stringsAsFactors = F, strip.white = T, na.strings = na_vals)
theme_set(theme_bw())


# read in needed datasets
coarse_summary <- read.csv("alpine_addnuts/output_data/forTS/sdl_nutnet_fxnl_biodiv_anpp_1997-ongoing.csv")
plantcom <- read.csv("alpine_addnuts/output_data/forTS/sdl_nutnet_sppcomp_1997-ongoing.csv")
sdlplots <- read.csv("alpine_addnuts/output_data/sdl_plot_lookup.csv") 
nnplots <- read.csv("alpine_addnuts/output_data/nutnet_plot_lookup.csv")
spplist <- read.csv("alpine_addnuts/output_data/sdl_nutnet_spplookup.csv")

# marko and soren's trait dataset -- will just consider saddle spp
traitdat <- getTabular(500) %>% data.frame()

# review read in as expected
glimpse(coarse_summary)
glimpse(plantcom)

# prep site info
# id nutnet plots and sdl plots sampled across all yrs
# sdl limited by sdl dry meadow non-snofence plots surveyed in 1997
# nutnet limitd by plots surveyed in 2017 (fewer than in 2013)
sdl_common <- unique(sdlplots$plot[!is.na(sdlplots$old_plot97LT) & sdlplots$snow == "no snow"])
nn_common <- unique(plantcom$plotid[plantcom$site == "nutnet" & plantcom$yr == 2017])
#to be sure, are these plots in 2013?
summary(nn_common %in% unique(plantcom$plotid[plantcom$site == "nutnet" & plantcom$yr == 2013])) # yup
# pull out P plots from nn too
nn_Pplots <- unique(nnplots$plotid[nnplots$trt == "P"])
#ts found no effect of +k, condense +k into other treatments (e.g. n+p+k to n+p; k to control)
# in previous ordination analysis, k plots overlay similar treatments without k (e.g. n+p and n+p+k hulls overlap on nmds) 
nnplots$trt2 <- gsub("[+]K", "", nnplots$trt)
nnplots$trt2 <- gsub("K", "C", nnplots$trt2)


# prep spp list
#make simple lifeform grp
spplist <- spplist %>%
  mutate(simple_lifeform = ifelse(Family == "Fabaceae", "N-fixer",
                                  ifelse(grepl("Shrub", Growth_Habit), "Shrub",
                                         ifelse(Growth_Habit == "Graminoid", "Grass", 
                                                ifelse(grep("Forb", Growth_Habit), "Forb", "Ground cover")))),
         # change Dryas to forb from shrub (is listed as subshrub/shrub/forb)
         simple_lifeform = ifelse(simple_name == "Dryas octopetala", "Forb", simple_lifeform),
         # fill in simple lifeform for 2FORB and 2GRAM
         simple_lifeform = ifelse(clean_code2 == "2FORB", "Forb",ifelse(clean_code2 == "2GRAM", "Grass", simple_lifeform)),
         # ground cover doesn't assign (maybe won't work on NA values of growth)
         simple_lifeform = ifelse(grepl("^2", clean_code2) & is.na(simple_lifeform), "Ground cover", simple_lifeform)) %>%
  # add alternative lifeform group where N-fixer lumped into forb group
  mutate(simple_lifeform2 = ifelse(simple_lifeform == "N-fixer", "Forb", simple_lifeform),
         # add nutnet grouping (Selaginella densa [spikemoss] = ground cover, not forb)
         nutnet_grp = ifelse(clean_code2 == "SEDES", "Ground cover", simple_lifeform2))



# specify plotting specs
# specify plotting colors for all treatments
# original treatments
alltrts <- sort(unique(nnplots$trt))
trtcols <- viridis::viridis(n = length(alltrts))
names(trtcols) <- alltrts

# simplified treatments
simpletrts <- sort(unique(c(as.character(sdlplots$trt))))
simplecols <- viridis::viridis(n = length(simpletrts))
names(simplecols) <- simpletrts

# specify plotting cols for lifeform
plantcols <- c("N-fixer" = "chocolate4", "Forb" = "grey30", "Grass" = "seagreen4", "Shrub" = "orchid")

# choose color scheme here to color in spp in nmds points with..
#traitcols <- c("Acquisitive" = "deeppink2", "Conservative" = "darkred", "Unknown" = "grey50")
traitcols <- c("Acquisitive" = "grey20", "Conservative" = "grey80", "Unknown" = "black")

# create plotting them for journal (target = Plant Ecol)
j_theme <- theme(axis.text = element_text(size = 10, family = "Arial"),
                 axis.title = element_text(size = 12, family = "Arial"),
                 legend.text = element_text(size = 10, family = "Arial"),
                 legend.title = element_text(size = 10, family = "Arial"),
                 strip.text = element_text(size = 10, family = "Arial"))

```


```{r prep fxnl trait data, include = F}

# subset dry meadow spp
traits_dm <- subset(traitdat, Exp == "SAD" & TRT == "DRY") %>%
  arrange(Year_Collected, USDA.Code, Rep)

# specify traits to use
trts <- colnames(traits_dm)[c(20, 25, 27:33)] # 16 = Oheight, 23 = dry weight -- not keeping bc using logged vars
trts 

# average dm trait vals and run through pca just to see..
meantraits <- traits_dm %>%
  # log transform physical traits
  mutate(ln_ohgt = log(OHeight),
         ln_drywgt = log(DryWeight),
         ln_leafarea = log(LeafArea)) %>%
  dplyr::select(Latin.name:Code, trts, ln_ohgt, ln_drywgt, ln_leafarea) %>%
  gather(met, val, CCAvg:ncol(.)) %>%
  filter(!is.na(val)) %>%
  group_by(USDA.Code, met) %>%
  summarise(meanval = mean(val)) %>%
  spread(met, meanval) %>%
  as.data.frame()

# specify spp as rownames
rownames(meantraits) <- meantraits$USDA.Code
# center and standardize trait vals
scaletraits <- scale(meantraits[,2:ncol(meantraits)])
# run pca
traitpc <- rda(scaletraits)
summary(traitpc) # copy paste results in console into excel spreadsheet for tim
biplot(traitpc, scaling = 2)


# extract pc scores to plot in treatment nmds plots 
sppscores <- data.frame(scores(traitpc)$sites) %>%
  mutate(USDA.Code = rownames(.)) %>%
  #bring in latin names from marko and soren's dataset
  left_join(distinct(traits_dm[c("USDA.Code", "Latin.name")])) %>%
  #join spp list data
  left_join(distinct(spplist[,2:ncol(spplist)]), by = c("Latin.name" = "simple_name")) %>%
  #clarify USDA Code
  rename(Marko.Code = USDA.Code) %>%
  mutate(resource_grp = ifelse(PC1 <= 0, "Conservative", "Acquisitive"))

varscores <- data.frame(scores(traitpc, display = "species"))
varscores$varnames <- rownames(varscores)
# assign abbreviated intelligible varnames for plot
varscores <- mutate(varscores, abbr = varnames) %>%
  mutate(abbr = recode(abbr,
                       CCAvg = "Chl",
                       CN_ratio = "C:N",
                       ln_drywgt = "Dry weight",
                       ln_ohgt = "Height",
                       ln_leafarea = "Leaf area",
                       Percent_C = "%C",
                       Percent_N = "%N"))

```


```{r alternate PCA, include = F}
# try expanding sites allowed (outside SDL DM) to allow more spp in analyses
# subset traitdat by species in Marko and Soren's dataset
# what matches the best?
summary(unique(traitdat$USDA.Code) %in% spplist$code)
summary(unique(traitdat$Species) %in% spplist$code)
summary(unique(traitdat$Latin.name) %in% spplist$simple_name) #bingo

traits_allsites <- left_join(traitdat, spplist[c("simple_name", "clean_code2")], by = c("Latin.name" = "simple_name"))
# pull out spp that didn't match
needs_match <- subset(traits_allsites, is.na(clean_code2)) %>%
  dplyr::select(Latin.name, Species, USDA.Code) %>% distinct()
# who is it?
sort(unique(needs_match$Latin.name))
# whose in spplist?
sort(unique(spplist$simple_name))
# what matches on NWT spp code
summary(unique(needs_match$Species) %in% spplist$code) #2..
unique(needs_match$Species)[unique(needs_match$Species) %in% spplist$code]
# what matches on Marko's USDA code?
summary(unique(needs_match$USDA.Code) %in% spplist$code)
unique(needs_match$USDA.Code)[(unique(needs_match$USDA.Code) %in% spplist$code)] # same ones
# match it by Species
for(i in unique(needs_match$Species)[unique(needs_match$Species) %in% spplist$code]){
  traits_allsites$clean_code2[traits_allsites$Species == i] <- spplist$clean_code2[spplist$code == i]
}
# match by USDA Code
for(i in unique(needs_match$USDA.Code)[unique(needs_match$USDA.Code) %in% spplist$code]){
  traits_allsites$clean_code2[traits_allsites$USDA.Code == i] <- spplist$clean_code2[spplist$code == i]
}

# check once more that didn't match
unique(traits_allsites$Latin.name[is.na(traits_allsites$clean_code2)]) #ok, move on
# remove spp that didn't match
traits_allsites <- subset(traits_allsites, !is.na(clean_code2))
# how many unique spp are there?
length(unique(traits_allsites$clean_code2)) #69 spp..
# where were these collected?
sapply(split(traits_allsites$TRT, traits_allsites$clean_code2), function(x)unique(x))
# look at variation in traits vals for a few spp collected across all sites (TRPAP, ERSI3, POBI6, MIOB2, GERO2, DECE)
subset(traits_allsites, clean_code2 %in% c("TRPAP", "ERSI3", "POBI6", "MIOB2", "GERO2", "DECE")) %>%
  dplyr::select(-Time, Lat, Long) %>%
  gather(met, val, SoilMoisture:CN_ratio) %>%
  mutate(TRT = ifelse(is.na(TRT), "Z", TRT)) %>%
  filter(met %in% c("SLA", "OHeight", "LMA")) %>%
  filter(!is.na(val) & Exp != "ITEX") %>%
  ggplot(aes(clean_code2,val)) +
  geom_boxplot() +
  geom_jitter(aes(col = TRT), alpha = 0.5) +
  facet_wrap(~met,scales = "free_y")

summary(is.na(traits_allsites)) # leaf area, SLA, LMA and OHeight have the most data

# let' just run everything and see what happens (if resource grp changes)


# average dm trait vals and run through pca just to see..
meantraits_allsites <- traits_allsites %>%
  # log transform physical traits
  mutate(ln_ohgt = log(OHeight),
         ln_drywgt = log(DryWeight)) %>%
  dplyr::select(clean_code2, VegHeight, OHeight, CCAvg:ln_drywgt) %>%
  gather(met, val, VegHeight:ncol(.)) %>%
  filter(!is.na(val)) %>%
  group_by(clean_code2, met) %>%
  summarise(meanval = mean(val, na.rm = T)) %>%
  spread(met, meanval) %>%
  as.data.frame()

# specify spp as rownames
rownames(meantraits_allsites) <- meantraits_allsites$clean_code2

# test pca using most variables possible
test1 <- na.omit(meantraits_allsites)
# run pca
traitpc_allsites_mostvars <- rda(scale(test1[,2:ncol(test1)]))
summary(traitpc_allsites_mostvars) # PC1 explains 35% variation
biplot(traitpc_allsites_mostvars, scaling = 2)

# test pca using as many spp as possible (lowest common denom of vars with data available)
hasdata <- apply(meantraits_allsites, 2, function(x) sum(!is.na(x)))
test2 <- meantraits_allsites[,hasdata>60] %>%
  na.omit() %>%
  dplyr::select(-OHeight)
# run pca
traitpc_allsites_mostspp <- rda(scale(test2[,2:ncol(test2)]))
summary(traitpc_allsites_mostspp) # PC1 explains about 40% variation
biplot(traitpc_allsites_mostspp, scaling = 2)


# extract pc scores to plot in treatment nmds plots 
sppscores_mostspp <- data.frame(scores(traitpc_allsites_mostspp)$sites) %>%
  mutate(clean_code2 = rownames(.)) %>%
  mutate(resource_grp_mostspp = ifelse(PC1 <= 0, "Acquisitive", "Conservative"),
         #try alternate grouping where spp in middle range are neutral,
         resource_grp_mostspp2  =ifelse(PC1 <= -0.2, "Acquisitive", ifelse(PC1 >= 0.2, "Conservative", "Neutral")))

varscores_mostspp <- data.frame(scores(traitpc_allsites_mostspp, display = "species"))
varscores_mostspp$varnames <- rownames(varscores_mostspp)
# assign abbreviated intelligible varnames for plot
varscores_mostspp <- mutate(varscores_mostspp, abbr = varnames) %>%
  mutate(abbr = recode(abbr,
                       CCAvg = "Chl",
                       CN_ratio = "C:N",
                       ln_drywgt = "Dry weight",
                       ln_ohgt = "Height",
                       ln_leafarea = "Leaf area",
                       Percent_C = "%C",
                       Percent_N = "%N"))

```


### Temporal trend in alpine dry meadow forb and grass relative abundance

As a double check, these are the replicated figures and tables I get following methods described in the manuscript draft. For the most part, numbers are very similar and may be slightly different due to old species codes being consolidated into the same USDA species code. I did find a number of typos in old species codes, which maybe could result in slight variation to diversity or richness numbers. The biggest difference in NutNet results here vs. what's shown in the manuscript is in at least 2013 *Selaginella densa* was classed and surveyed as ground cover (non-vegetation hits). That is, I can replicate 2013 numbers in the current draft ms when I also class *S. densa* as ground cover. In other surveys, however, *S. densa* was not necessarily surveyed as ground cover (for example, it was recorded below grass at a given point, or a in few cases, other plants were recorded as hit below *S. densa* at the top). *S. densa* is a vascular plant, and is relatively abundant in some plots, so I treated it as plant cover across all years and sites in results presented here.

With that, here are the updated figures and tables I get using the cleaned datasets, along with some additional figure panels, tables, or figures using new data added to the time-series dataset (e.g. 2003 and 2005 saddle sffert data). The 2003 and 2005 saddle data are REU data (2003 = Colin Tucker, REU with Bill Bowman; 2005 = Jane Griffin Smith, REU with Tim Seastedt), so not sure if data quality (specifically plant ID) is sufficient enough to want to include in the ms analyses, but at minimum *Geum rossii* numbers align with the rest of the Saddle *Geum rossii* time-series data and I think would be interesting data points to include.


#### Saddle trends

```{r Prep sdl mean forb and grass rel cover and ANOVA tables}
# split out sdl and nutnet so can average C and N+P+K
sdl_coarse <- subset(coarse_summary, site == "sdl") %>%
  # select only dry meadow plots consistently sampled
  # subset to dry meadow plots surveyed across all years only (corresponds to what was surveyed in 1997)
  ## should be plots 1-16
  subset(plotid %in% sdl_common) %>%
  # make treatment a factor
  mutate(trt = factor(trt, levels = c("C", "N", "P", "N+P")))

# stack for anova
sdl_coarse_tall <- gather(sdl_coarse, met, val, ForbHits:ncol(sdl_coarse))

# run anova
fg_anova_global <- aov(val ~ trt * met * yr, data = subset(sdl_coarse_tall, met %in% c("Forb_rel", "Grass_rel")))

# iterate through anovas by year
anova_df <- data.frame()
tukey_df <- data.frame()
for(i in unique(sdl_coarse$yr)){
  tempanova <- aov(val ~ trt * met, data = subset(sdl_coarse_tall, met %in% c("Forb_rel", "Grass_rel") & yr == i))
  tempresults <- data.frame(cbind(site = "sdl", yr = i, broom::tidy(tempanova)))
  anova_df <- rbind(anova_df, tempresults)
  
  # run tukey test and keep only signif differences
  temptukey <- TukeyHSD(tempanova)
  for(n in names(temptukey)){
    signifdiff <- data.frame(temptukey[[n]]) %>%
      rownames_to_column("comparison") %>%
      mutate(term = n,
             yr = i)
    tukey_df <- rbind(tukey_df, signifdiff)
  }
}
# clean up
anova_df <- filter(anova_df, !term == "Residuals") %>%
  dplyr::select(site, yr, term, statistic, p.value) %>%
  rename(F.stat = statistic) %>%
  gather(met, val, F.stat, p.value) %>%
  mutate(term = gsub("met", "fxngrp", term)) %>%
  mutate(val = round(val, 4)) %>%
  unite(grp, term, met, sep = "_") %>%
  spread(grp,val)
tukey_df <- subset(tukey_df, p.adj <= 0.05)

# average by treatment -- average all mets, then subset for figs and tables as needed
sdl_coarse_means <- sdl_coarse %>%
  gather(grp, val, ForbHits:ncol(.)) %>%
  group_by(site, yr, trt, meadow, snow, grp) %>%
  summarise(meanval = mean(val),
            seval = sd(val)/sqrt(length(val)),
            nobs = length(val)) %>%
  ungroup() %>%
  # calculate yrs passed since start of exp
  mutate(post_yrs = yr - 1993)
```


```{r Fig 1 and ANOVA, fig.cap="Fig 1. Mean relative forb and grass cover, Saddle, 1997-2016"}
# visualize
ggplot(data= subset(sdl_coarse_means, grp  %in% c("Forb_rel", "Grass_rel")), aes(trt, meanval, fill = grp)) +
  geom_errorbar(aes(ymax = meanval + seval, ymin = meanval-seval, col = grp), width = 0.25, position = position_dodge(width = 0.6)) +
  geom_col(color = "grey30", position = position_dodge(width = 0.6), width = 0.5) +
  scale_color_grey(name = "Group", labels = c("Forb", "Grass")) +
  scale_fill_grey(name = "Group", labels = c("Forb", "Grass")) +
  scale_y_continuous(expand = c(0,0), limit = c(0,86)) +
  labs(y = "Mean relative cover (%)",x = "Treatment") +
  theme(legend.position = c(0.78,0.35),
        legend.justification = c(0.78, 0.35),
        legend.key.size = unit(9, "pt"),
        legend.background = element_blank()) +
  j_theme +
  facet_wrap(~yr, nrow = 2)

# write out tif
ggsave("alpine_addnuts/figures/journal_figs/sdl_meancov.tiff", dpi = 320,
       width = 6, height = 4, units = "in")
```


```{r Fig 1 related SDL means table}
kable(dplyr::select(sdl_coarse_means, site, yr, trt, grp, meanval, seval) %>%
        filter(grp %in% c("Forb_rel", "Grass_rel")) %>%
        rename(fxnlgrp = grp) %>%
        mutate(fxnlgrp = gsub("_rel", "", fxnlgrp)) %>%
        gather(cat, val, meanval, seval) %>%
        mutate(cat = gsub("val", "", cat)) %>%
        unite(grp, trt, cat, sep = " ") %>%
        spread(grp, val), digits = 2, label = "Table S1. Mean relative forb and grass cover, Saddle, 1997-2016. Means, 1 standard error, n = 4 per treatment.")
```

You'll notice standard errors are the same per treatment per year (e.g. 5.72 for both Forb and Grass in Control in 1997). I think this happens because Grass relative cover is 100-Forb relative cover, and so they will have a comparable amount of deviation (i.e. standard deviation is the same), and the sample size for both is 4.

I did throw everything in a global ANOVA just to see if there are any significant effects or interactions between treatment, functional group, and time. "Met" here is short for metric, but standard for functional group (forb or grass). Mean cover between forb and grass overall is statistically distinct, and there is an interaction between functional group and treatment, with a small statistically significant interaction between treatment, functional group, and time.

```{r Fig 1 global ANOVA}
summary(fg_anova_global)
```

By year, here are the ANOVA results. Functional group is significant in all years but 1997, treatment never is (because it would be the mean by treatment.. which always averages to 50).. and the interaction between functional group and treatment always is!

```{r Fig 1 related SDL ANOVA results}
kable(anova_df, caption = "Table S2. ANOVA results for saddle, effects of treatment and functional group (forb or grass) on mean relative cover. Separate ANOVAs were run by year, n=4 per treatment, per functional group.")

kable(arrange(tukey_df, yr, term, comparison), digits = 4, caption = "Saddle: Tukey HSD, significant differences (p<=0.05), ANOVAs run separately for each year")
```

Out of curiosity, and acknowledging differences in sampling methods in certain years (e.g. top hits only in 1997, 50-point subset in 2005) is there a treatment effect and grass and forb hits (not relativized cover) within year?

```{r}
# visualize
ggplot(data= subset(sdl_coarse_means, grp  %in% c("ForbHits", "GrassHits")), aes(trt, meanval, fill = grp)) +
  geom_errorbar(aes(ymax = meanval + seval, ymin = meanval-seval, col = grp), width = 0.1, position = position_dodge(width = 0.6)) +
  geom_col(color = "grey30", position = position_dodge(width = 0.6), width = 0.5) +
  scale_color_grey(name = "Group", labels = c("Forb", "Grass")) +
  scale_fill_grey(name = "Group", labels = c("Forb", "Grass")) +
  labs(y = "Mean hits",x = "Treatment") +
  theme(legend.position = c(0.8,0.3),
        legend.title = element_text(size = 10)) +
  facet_wrap(~yr, nrow = 2)

# iterate through anovas by year
anova_df_hits <- data.frame()
for(i in unique(sdl_coarse$yr)){
  tempanova <- aov(val ~ trt * met, data = subset(sdl_coarse_tall, met %in% c("ForbHits", "GrassHits") & yr == i))
  tempresults <- data.frame(cbind(site = "sdl", yr = i, broom::tidy(tempanova)))
  anova_df_hits <- rbind(anova_df_hits, tempresults)
}
# clean up
anova_df_hits <- filter(anova_df_hits, !term == "Residuals") %>%
  dplyr::select(site, yr, term, statistic, p.value) %>%
  rename(F.stat = statistic) %>%
  gather(met, val, F.stat, p.value) %>%
  mutate(term = gsub("met", "fxngrp", term)) %>%
  mutate(val = round(val, 4)) %>%
  unite(grp, term, met, sep = "_") %>%
  spread(grp,val)

kable(anova_df_hits)
```

Mean hits by treatment are significantly different from one another in 2012, otherwise no major differences in what's significant each year using hits only compared to relativized cover. 


#### NutNet Trends

```{r Fig 2 and ANOVA tables, fig.cap= "Fig 2. NutNet mean forb and grass relative cover, 2013 and 2017"}
# nutnet
## need to average N+P and C by block first (2 reps per block)
nn_coarse_blockmeans <- subset(coarse_summary, site == "nutnet") %>% 
  # select only plots consistently sampled both years
  #subset(plotid %in% c(nn_common, nn_Pplots)) %>% 
  # modify N+K plot to N in 2017 so block 4 has a 4th N trtment
  mutate(trt = ifelse(yr == 2017 & grepl("B4", plotid) & trt == "N+K", "N", trt)) %>%
  gather(met, val, ForbHits:ncol(.)) %>%
  # average reps in C and N+P+K by block
  group_by(site, yr, block, trt, trt2, met) %>%
  summarise(blockmean = mean(val),
            # to verify 2 obs per C and N+P+K per block
            nobs = length(val)) %>% # yes (checked manually)
  ungroup()

# subset to just C, N and N+P for fig2 and anova
nn_fg_dat <- subset(nn_coarse_blockmeans, met %in% c("Forb_rel", "Grass_rel", "Geum_rel", "ForbHits", "GrassHits") & trt %in% c("C", "N", "P", "N+P")) %>%
  mutate(trt2 = factor(trt2, levels = c("C", "N", "P", "N+P")))

# run anova of forbs and grass rel cov, using C, N and N+P only (so 4 reps per trt) [i.e. ignore K, N+P+K]
nn_fg_anova_global <- aov(blockmean ~ trt2 * met * yr, data = subset(nn_fg_dat, met %in% c("Grass_rel", "Forb_rel") & trt2 != "P"))


# by year
nn_fg_anova13 <- aov(blockmean ~ trt2 * met, data = subset(nn_fg_dat, yr == 2013 & met %in% c("Grass_rel", "Forb_rel")))
nn_fg_anova17 <- aov(blockmean ~ trt2 * met, data = subset(nn_fg_dat, yr == 2017 & met %in% c( "Grass_rel", "Forb_rel") & trt2 != "P"))

# gather results
nn_anova_df <- rbind(cbind(site = "nutnet", yr = 2013, broom::tidy(nn_fg_anova13)),
                     cbind(site = "nutnet", yr = 2017, broom::tidy(nn_fg_anova17))) %>%
  filter(!term == "Residuals") %>%
  dplyr::select(site, yr, term, statistic, p.value) %>%
  rename(F.stat = statistic) %>%
  gather(met, val, F.stat, p.value) %>%
  mutate(term = gsub("met", "fxngrp", term)) %>%
  mutate(val = round(val, 4)) %>%
  unite(grp, term, met, sep = "_") %>%
  spread(grp,val)

# calculate table of means and ses
nn_fg_means <- data.frame(nn_fg_dat) %>%
  group_by(site, yr, trt2, met) %>%
  summarise(meancov = mean(blockmean),
            secov = sd(blockmean)/sqrt(4),
            nobs = length(blockmean)) %>%
  ungroup() %>%
  # calculate yrs passed since start of exp
  mutate(post_yrs = yr - 2008) %>%
  as.data.frame()

# visualize
ggplot(data= subset(nn_fg_means, met %in% c("Grass_rel", "Forb_rel")), aes(trt2, meancov, fill = met)) +
  geom_errorbar(aes(ymax = meancov + secov, ymin = meancov-secov, col = met), width = 0.25, position = position_dodge(width = 0.6)) +
  geom_col(color = "grey30", position = position_dodge(width = 0.6), width = 0.5) +
  scale_color_grey(name = NULL, labels = c("Forb", "Grass")) +
  scale_fill_grey(name = NULL, labels = c("Forb", "Grass")) +
  labs(y = "Mean relative cover (%)", x = "Treatment") +
  scale_y_continuous(expand = c(0,0), limits = c(0,75)) +
  theme(legend.position = c(-0.05,1.05),
        legend.justification = c(-0.05, 1.05),
        legend.background = element_blank(),
        legend.key.size = unit(9, "pt"),
        legend.direction = "horizontal") +
  j_theme +
  facet_wrap(~yr, ncol = 2)

# save tiff
ggsave("alpine_addnuts/figures/journal_figs/nn_meancov.tiff", dpi= 320,
       width = 4, height = 2.2, units = "in")

```

```{r NutNet functional group means}
kable(nn_fg_means[nn_fg_means$met %in% c("Grass_rel", "Forb_rel"),1:6] %>% 
        rename(fxnlgrp = met) %>%
        mutate(fxnlgrp = gsub("_rel", "", fxnlgrp)) %>%
        gather(cat, val, meancov, secov) %>%
        mutate(cat = gsub("cov", "", cat)) %>%
        unite(grp, trt2, cat, sep = " ") %>%
        spread(grp, val), digits = 2, caption = "NutNet mean forb and grass relative cover, by treatment (means, 1 standard error, n = 4 per treatment; 2 reps of C and N+P+K within block averaged before calculating treatment averages across blocks)")

```

Again, trying everything in a global ANOVA (functional group x treatment x yr), and running two separate ANOVAs for 2013 and 2017. Two replicates for C and N+P+K within block were averaged before running the ANOVA, so that each block only has 1 value of mean grass and 1 value of mean forb per treatment.

```{r NutNet ANOVA tables}
summary(nn_fg_anova_global)
kable(nn_anova_df, caption = "NutNet grass vs. forb vs. treatment ANOVA, by year")
```

Dissimilar to Saddle trends, nothing is significant at the NutNet site. 

```{r NutNet hits ANOVA}
# by year
nn_fghits_anova13 <- aov(blockmean ~ trt2 * met, data = subset(nn_fg_dat, yr == 2013 & met %in% c("GrassHits", "ForbHits")))
nn_fghits_anova17 <- aov(blockmean ~ trt2 * met, data = subset(nn_fg_dat, yr == 2017 & met %in% c( "GrassHits", "ForbHits") & trt2 != "P"))

# gather results
nn_anovahits_df <- rbind(cbind(site = "nutnet", yr = 2013, broom::tidy(nn_fghits_anova13)),
                         cbind(site = "nutnet", yr = 2017, broom::tidy(nn_fghits_anova17))) %>%
  filter(!term == "Residuals") %>%
  dplyr::select(site, yr, term, statistic, p.value) %>%
  rename(F.stat = statistic) %>%
  gather(met, val, F.stat, p.value) %>%
  mutate(term = gsub("met", "fxngrp", term)) %>%
  mutate(val = round(val, 4)) %>%
  unite(grp, term, met, sep = "_") %>%
  spread(grp,val)

# visualize
ggplot(data= subset(nn_fg_means, met %in% c("GrassHits", "ForbHits")), aes(trt2, meancov, fill = met)) +
  geom_errorbar(aes(ymax = meancov + secov, ymin = meancov-secov, col = met), width = 0.1, position = position_dodge(width = 0.6)) +
  geom_col(color = "grey30", position = position_dodge(width = 0.6), width = 0.5) +
  scale_color_grey(name = "Group", labels = c("Forb", "Grass")) +
  scale_fill_grey(name = "Group", labels = c("Forb", "Grass")) +
  labs(y = "Mean hits", x = "Treatment") +
  theme(legend.title = element_text(size = 10)) +
  facet_wrap(~yr, ncol = 2)

kable(nn_anovahits_df, digits = 4, caption = "NutNet: ANOVA on mean hits")
nn13hitstukey <- TukeyHSD(nn_fghits_anova13)
nn13hits_tk_df <- data.frame(rbind(cbind(comparison = rownames(nn13hitstukey$met), nn13hitstukey$met, grp = "met", yr = 2013),
                                   cbind(comparison = rownames(nn13hitstukey$trt2), nn13hitstukey$trt2, grp = "trt2", yr = 2013),
                                   cbind(comparison = rownames(nn13hitstukey$`trt2:met`), nn13hitstukey$`trt2:met`,grp = "trt2:met", yr = 2013))) %>%
  mutate_at(c("diff", "lwr", "upr", "p.adj"), as.numeric) %>%
  filter(p.adj <= 0.05)
kable(nn13hits_tk_df, digits = 4, caption = "NutNet 2013: Significant differences in mean hits (p < 0.05) between functional groups and treatments, tested with Tukey HSD")
```



When everything is plotted together, you can see how the shift in *G. rossii* cover at Saddle is driving the shift in forb cover over time. Plotting both sites together also suggests perhaps NutNet is on a similar trajectory to Saddle in shift to forb dominance over time with N+P additions, but not enough years (and N+P additions) have occurred to confirm that trend.

```{r all together}
# stack sdl and nutnet to plot means and ses by yr since trts initiated
all_fg_means <- rename(nn_fg_means, trt = trt2, grp = met, meanval = meancov, seval = secov) %>%
  rbind(dplyr::select(sdl_coarse_means, -c(meadow, snow))) %>%
  filter(grp %in% c("Forb_rel", "Grass_rel", "Geum_rel"))


# plot means by time since experiment onset
mutate(all_fg_means, grp = factor(grp, levels = c("Forb_rel", "Grass_rel", "Geum_rel"), labels = c("All forbs", "All grasses", "G. rossii"))) %>%
  ggplot(aes(post_yrs, meanval, grp = site)) +
  geom_errorbar(aes(ymax = meanval + seval, ymin = meanval - seval), width = 0) +
  geom_point(aes(shape = site), fill = "white") +
  #geom_line(aes(col = site)) +
  #scale_color_manual(name = "Site", values = c("salmon", "darkred"), labels = c("NutNet", "Saddle")) +
  scale_shape_manual(name = "Site", values = c(21,19), labels = c("NutNet", "Saddle")) +
  labs(y = "Mean relative cover (%)",
       x = "Years since experiment onset") +
  theme(legend.title = element_text(size = 10),
        axis.title = element_text(size = 12, family = "Arial")) +
  facet_grid(grp~trt, scales = "free_y")
```

Finally, here are the tables 1-4 recreated using the cleaned datasets:


```{r nutnet biodiversity tables, include = F}
# collapse K (micro) into otherwise similar treatments (n = 8 per group)
# summarise 2013
nn_biodiv13_means <- subset(nn_coarse_blockmeans, yr == 2013) %>%
  group_by(site, yr, trt2, met) %>%
  summarise(meancov = mean(blockmean),
            secov = sd(blockmean)/sqrt(length(blockmean)),
            nobs = length(blockmean)) %>%
  ungroup() %>%
  # calculate yrs passed since start of exp
  mutate(post_yrs = yr - 2008) %>%
  as.data.frame()

# visualize
ggplot(nn_biodiv13_means, aes(trt2, meancov)) +
  geom_errorbar(aes(ymax = secov + meancov, ymin = meancov - secov), width = 0.1) +
  geom_point() +
  facet_wrap(~met, scales = "free_y")

# summarise 2017
nn_biodiv17_means <- subset(nn_coarse_blockmeans, yr == 2017) %>%
  group_by(site, yr, trt, met) %>%
  summarise(meancov = mean(blockmean),
            secov = sd(blockmean)/sqrt(length(blockmean)),
            nobs = length(blockmean)) %>%
  ungroup() %>%
  filter(!is.na(meancov)) %>%
  # calculate yrs passed since start of exp
  mutate(post_yrs = yr - 2008) %>%
  as.data.frame()

# visualize
ggplot(nn_biodiv17_means, aes(trt, meancov)) +
  geom_errorbar(aes(ymax = secov + meancov, ymin = meancov - secov), width = 0.1) +
  geom_point() +
  facet_wrap(~met, scales = "free_y")

```


```{r Table 1 NutNet 2013 biodiv means}

kable(dplyr::select(nn_biodiv13_means, -post_yrs) %>%
        gather(cat, val, meancov, secov) %>%
        filter(met %in% c("S", "H", "PlantCov", "Total_g_m2", "VegHits")) %>%
        unite(grp, trt2, cat) %>%
        spread(grp, val) %>%
        mutate(met = factor(met, levels = c("S", "H", "PlantCov", "Total_g_m2", "VegHits"))) %>%
        arrange(met) %>%
        # reorder cols
        dplyr::select(site:N_secov, P_meancov, P_secov, `N+P_meancov`:ncol(.)) %>%
        rename(variable = met) %>%
        rename_all(function(x) trimws(gsub("_|cov", " ",x))), 
      digits = 2, caption = "Table 1. NN 2013 biodiversity, vegetation complexity, and biomass trends per treatment (means, 1 standard error, nutrient and nutrient+micro treatments pooled (8 per group)")

```


```{r}
kable(dplyr::select(nn_biodiv17_means, -post_yrs) %>%
        gather(cat, val, meancov, secov) %>%
        filter(met %in% c("S", "H", "PlantCov", "Total_g_m2", "VegHits")) %>%
        unite(grp, trt, cat) %>%
        spread(grp, val) %>%
        mutate(met = factor(met, levels = c("S", "H", "PlantCov", "Total_g_m2", "VegHits"))) %>%
        arrange(met) %>%
        # reorder cols
        #dplyr::select(site:N_secov, P_meancov, P_secov, `N+P_meancov`:ncol(.)) %>%
        rename(variable = met) %>%
        rename_all(function(x) trimws(gsub("_|cov", " ",x))), 
      digits = 2, caption = "Table 2. NN 2017 biodiversity, and vegetation complexity (biomass not measured) trends per treatment (means, 1 standard error, n = 4 per treatment [C and N+P+K reps averaged within block (2 rep per block) first]")
```


Out of curiosity, I repeated this for Saddle for years where data are available:

```{r sdl biodiversity, fig.cap="Saddle biodiversity, biomass, and vegetation complexity, for years where data available (means, ± 1 std. error, n = 4 per treatment"}
sdl_biodiv_means <- sdl_coarse_means %>%
  filter(grp %in% c("S", "H", "PlantCov", "Total_g_m2", "VegHits")) %>%
  filter(!is.na(meanval))


# visualize
ggplot(sdl_biodiv_means, aes(post_yrs, meanval, col = trt)) +
  geom_errorbar(aes(ymax = seval + meanval, ymin = meanval - seval), width = 0.1, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3), alpha = 0.75, lty = 2) +
  geom_point(position = position_dodge(width = 0.3)) +
  #scale_x_continuous(breaks = c(unique(sdl_biodiv_means$yr))) +
  labs(y = "Mean value", x = "Years since experiment onset") +
  scale_color_manual(name = "Treatment", values = trtcols) +
  theme(legend.position = c(0.8, 0.25),
        legend.title = element_text(size = 10)) +
  facet_wrap(~grp, scales = "free_y")
```


```{r Geum rossii table}
geum_table <- subset(all_fg_means, trt %in% c("C", "N", "P", "N+P") & grp == "Geum_rel") %>%
  # drop post_yrs and grp (since all Geum cov)
  dplyr::select(-c(post_yrs, grp)) %>%
  # make site just first letter and capitalized
  mutate(site = casefold(substr(site, 1,1), upper = T)) %>%
  unite(grp, site,yr, sep =" ") %>%
  # gather mean and se to spread out by year
  gather(met, val, meanval, seval) %>%
  #remove "val" from metric
  mutate(met = gsub("val", "", met)) %>%
  unite(cat, grp, met, sep = " ") %>%
  spread(cat, val) %>%
  # reorder cols
  dplyr::select(trt, nobs, `S 1997 mean`:`S 2016 se`, `N 2013 mean`:`N 2017 se`) %>%
  rename(Treatment = trt, n = nobs)

kable(geum_table, digits = 2,
      caption = "Table 3. Mean relative cover of G. rossii at alpine dry meadow plots over time (means, ±1 std error, n = 4 per treatment. S = Saddle, N = NutNet.")
```


```{r abundant forbs in nutnet, include = F}
abundance <- subset(plantcom, hits > 0.25 & simple_lifeform != "Ground cover") %>%
  dplyr::select(site, yr, plotid, block, plot, trt, trt2, clean_code2, hits)

# make wide form
abundance_wide <- spread(abundance, clean_code2, hits, fill = 0) %>%
  unite(rowid, site, yr, plotid, sep = "_", remove = F)

# relativize -- some sites will have extra spp because spread out all plantcom data from both sites
relabundance <- abundance_wide
rownames(relabundance) <- abundance_wide$rowid
# plantdat begins after trt2
relabundance <- decostand(relabundance[,(which(names(relabundance) == "trt2")+1):ncol(relabundance)], "total")
# multiple by 100 to get % relative cover value
relabundance <- relabundance*100

# id forbs with >2% average cover
nn17abundance <- relabundance[grepl("2017", rownames(relabundance)),]
# remove any spp that were never in any sites in 2017 (colsum == 1)
nn17abundance <- nn17abundance[,apply(nn17abundance, 2, sum)>0]
# double check all still sums to 100
apply(nn17abundance, 1, sum) # yes
nn17abundance <- nn17abundance %>%
  mutate(rowid = rownames(.)) %>%
  left_join(dplyr::select(abundance_wide, rowid:trt2)) %>%
  dplyr::select(rowid:trt2, names(.)[1]:ncol(.)) %>%
  gather(clean_code2, relcov, (grep("trt2", names(.))+1):ncol(.)) %>%
  # take average abundances of C and N+P+K by block
  group_by(site, yr, block, trt, trt2, clean_code2) %>%
  summarise(blockmean = (mean(relcov)),
            nobs = length(relcov)) %>%
  ungroup()

# average
nn17abund_means <- nn17abundance %>%
  mutate(trt = recode(trt, "N+K" = "N")) %>%
  group_by(site, yr, trt, trt2, clean_code2) %>%
  summarise(mean_relcov = round(mean(blockmean),2),
            se_relcov = round(sd(blockmean)/sqrt(length(blockmean)),2),
            nobs = length(blockmean)) %>%
  ungroup()

#id spp that have 0.2 or greater relcov (should be multiplied by 100 for final table)
keepspp <- sort(unique(nn17abund_means$clean_code2[nn17abund_means$mean_relcov >= 2]))
keepspp

table_nn17spp <- subset(nn17abund_means, clean_code2 %in% keepspp) %>%
  dplyr::select(-c(trt2)) %>%
  gather(met, val, mean_relcov, se_relcov) %>%
  unite(grp, trt, met) %>%
  spread(grp, val) %>%
  left_join(distinct(spplist[c("clean_code2", "simple_name", "simple_lifeform2")])) %>%
  # join resource grp info
  left_join(sppscores[c("clean_code2", "resource_grp")]) %>%
  mutate(resource_grp = ifelse(is.na(resource_grp), "Unknown", resource_grp)) %>%
  # clean up colnames
  rename_all(function(x) gsub("_relcov", "", x)) %>%
  #recorder cols
  dplyr::select(site, yr, nobs, clean_code2, simple_name, simple_lifeform2, resource_grp, C_mean:ncol(.))
table_nn17spp$sortcol <- apply(dplyr::select(table_nn17spp, C_mean,N_mean, K_mean, `N+P_mean`, `N+P+K_mean`),1, sum)

```

Abundant species in NutNet plots by the final year:

```{r}
kable(rename_all(table_nn17spp, function(x)gsub("_", " ", x)) %>%
        rename(lifeform = `simple lifeform2`,
               species = `simple name`) %>%
        arrange(lifeform, desc(sortcol)) %>%
        dplyr::select(-sortcol), caption = "Table 4. NutNet 2017, species with mean abundance >= 2% in any treatment, sorted by lifeform and overall mean abundance, n = 4 per treatment group")
```


#### Multivariate analyses
Considering the same plots analyzed above for forb and grass relative cover, what can we learn from multivariate analyses about shifts in forb and grass species abundances by treatment overtime at each site?

```{r trait pca, fig.cap = "Fig 3. PCA of functional traits for available Saddle dry meadow species in Spasojevic and Weber (2018)"}
# gather proportional importance for axes labels
PCexplain <- data.frame(summary(traitpc)$cont$importance) %>%
  rownames_to_column()

# specify species text size
plottext <- 3.5
pointsize <- 3

pcfig <- ggplot() +
  geom_vline(aes(xintercept = 0), lty = 2, col = "grey") +
  geom_hline(aes(yintercept = 0), lty = 2, col = "grey") +
  geom_segment(data=varscores,aes(x=0,xend=PC1,y=0,yend=PC2),
               arrow = arrow(length = unit(0.25, "cm")),colour="grey40") + 
  geom_point(data = sppscores, aes(PC1, PC2, col = resource_grp), size = pointsize) +
  geom_text(data = subset(varscores, PC1 <=0 & !grepl("D13", abbr)), aes(PC1, PC2, label = abbr), check_overlap = T, hjust = 1, nudge_x = -0.02, size = plottext) +
  # plot D13c separately
  geom_text(data = subset(varscores,abbr == "D13C"), aes(PC1, PC2, label = abbr), check_overlap = T, hjust = 0.5, nudge_y = -0.1, size = plottext) +
  geom_text(data = subset(varscores, PC1 >0 & !grepl("D15|Chl", abbr)), aes(PC1, PC2, label = abbr), check_overlap = T, hjust = -0.1, size = plottext) +
  # plot leaf area separately
  geom_text(data = subset(varscores, abbr == "Leaf area"), aes(PC1, PC2, label = abbr), size = plottext) +
  # D15N and Chl
  geom_text(data = subset(varscores, abbr %in% c("D15N", "Chl")), aes(PC1, PC2, label = abbr), check_overlap = F, vjust = 0, hjust = -0.1, size = plottext) +
  labs(x = paste0("PC1 (",round(PCexplain$PC1[grepl("^Prop", PCexplain$rowname)],2)*100, "% variance explained)"),
       y = paste0("PC2 (",round(PCexplain$PC2[grepl("^Prop", PCexplain$rowname)],2)*100, "% variance explained)")) +
  # describe axes
  geom_segment(aes(x=0.1,xend=2,y=(min(sppscores$PC2)-0.18),yend=(min(sppscores$PC2)-0.18)),
               arrow = arrow(length = unit(0.25, "cm")),colour="grey40", alpha = 0.4, lwd = 0.75) +
  geom_segment(aes(x=-0.1,xend=-1.5,y=(min(sppscores$PC2)-0.18),yend=(min(sppscores$PC2)-0.18)),
               arrow = arrow(length = unit(0.25, "cm")),colour="grey40", alpha = 0.4, lwd = 0.75) +
  geom_text(aes(2, (min(sppscores$PC2)-0.08), label = "Resource\nacquisitive"), fontface = "italic", col = "grey20", size = plottext, hjust = 1, vjust = 0, lineheight = 0.75) +
  geom_text(aes(-1.5, (min(sppscores$PC2)-0.08), label = "Resource\nconservative"), fontface = "italic", col = "grey20", size = plottext, hjust = 0, vjust = 0, lineheight = 0.75) +
  #coord_fixed() +
  theme(panel.grid = element_blank()) +
  j_theme +
  scale_color_manual(values = traitcols, guide = FALSE)


pcfig

ggsave("alpine_addnuts/figures/journal_figs/pca_nospp.tiff", dpi = 320,
       width = 4, height = 4, units = "in")
```



```{r multivariate analysis nmds, permanova, and betadisper, include=F}

# create function for storing ellipse (from: https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo)
veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100){
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

# procedure:
## subset data to common plots only so can compare across yrs
## sdl data can be run through as they are (C, N, P, N+P)
## nutnet data need to be block-averaged (2 reps of C and N+P+K in each block)
## then different iterations of nutnet run:
## 1) C, N, P and N+P only
## 2) all trts (+K)
## 3) K-collapsed trts (e.g. N+P+K becomes N+P) [this pertains to 2013 in particular bc no K added then, just micronuts]
# prep abundance data to feed through for loop by site, add on a col to keep track of iteration, then feed through for-loop

# make block-averaged nn abundance dat
nnabundance <- relabundance[grepl("nutnet", rownames(relabundance)),] %>%
  rownames_to_column("rowid") %>%
  left_join(dplyr::select(abundance_wide, rowid:trt2)) %>%
  dplyr::select(rowid,site:trt2, colnames(.)[colnames(.) %in% unique(spplist$clean_code2)]) %>%
  gather(clean_code2, relcov, colnames(.)[colnames(.) %in% unique(spplist$clean_code2)]) %>%
  group_by(site, yr, block, trt, trt2, clean_code2) %>%
  summarise(rcblockmean = mean(relcov),
            nobs = length(relcov)) %>%
  ungroup() %>%
  # add iteration
  mutate(iter = "suppl") %>%
  # recode 2017 N+K to N so has 4 N reps that yr
  mutate(trt = ifelse(yr == 2017 & trt == "N+K", "N", trt)) %>%
  # join F2G ratio from coarse means
  left_join(subset(nn_coarse_blockmeans, met == "F2G_ratio")) %>%
  # change block to id and drop nobs
  rename(id = block,
         F2G_ratio = blockmean) %>%
  dplyr::select(-c(trt2, met)) %>%
  #make wideform
  spread(clean_code2, rcblockmean) %>%
  # add rowid
  unite(rowid, site, yr, id, trt, iter, remove = F)

#subset common plots nn abundance
nnabund_comm <- relabundance[grepl("nutnet", rownames(relabundance)),] %>%
  rownames_to_column("rowid") %>%
  left_join(dplyr::select(abundance_wide, rowid:trt2)) %>%
  filter(plotid %in% nn_common) %>%
  dplyr::select(rowid,site:trt2, colnames(.)[colnames(.) %in% unique(spplist$clean_code2)]) %>%
  gather(clean_code2, relcov, colnames(.)[colnames(.) %in% unique(spplist$clean_code2)]) %>%
  group_by(site, yr, block, trt, trt2, clean_code2) %>%
  summarise(rcblockmean = mean(relcov),
            nobs = length(relcov)) %>%
  ungroup() %>%
  #recode N+K to N so have 4 points 
  mutate(trt = recode(trt, `N+K` = "N"),
         # add iteration
         iter = "main") %>%
  # recode 2017 N+K to N so has 4 N reps that yr
  mutate(trt = ifelse(yr == 2017 & trt == "N+K", "N", trt)) %>%
  # join F2G ratio from coarse means
  left_join(subset(nn_coarse_blockmeans, met == "F2G_ratio")) %>%
  # change block to id and drop nobs
  rename(id = block,
         F2G_ratio = blockmean) %>%
  dplyr::select(-c(trt2, met)) %>%
  spread(clean_code2, rcblockmean) %>%
  # retain only plots in N, P, C, or N+P
  filter(trt %in% c("C", "N", "P", "N+P")) %>%
  # add rowid
  unite(rowid, site, yr, id, trt, iter, remove = F)


# get all relativized sdl data
sdlabundance <- relabundance[grepl("sdl", rownames(relabundance)),] %>%
  mutate(rowid = rownames(.)) %>%
  # join trt info
  left_join(dplyr::select(abundance_wide, rowid:plotid, trt)) %>%
  # select plots commonly sampled across yrs
  filter(plotid %in% sdl_common) %>%
  # add iteration
  mutate(iter = "main",
         nobs = 1) %>%
  #join F2G ratio
  left_join(dplyr::select(coarse_summary, site:plotid, F2G_ratio)) %>%
  #reorder cols (drop rowid to remake)
  dplyr::select(site:F2G_ratio, colnames(.)[colnames(.) %in% unique(spplist$clean_code2)]) %>%
  rename(id = plotid) %>%
  # add rowid
  unite(rowid, site, yr, id, trt, iter, remove = F)

# stack all
relstack <- rbind(nnabundance, nnabund_comm, sdlabundance) %>% as.data.frame() %>%
  # unite yr and iteration to id iterations in for loop
  unite(tracker, iter,yr, remove = F)
rownames(relstack) <- relstack$rowid
envmatrix <- relstack[!colnames(relstack) %in% unique(spplist$clean_code2)] %>%
  # add natural log transformed F2G
  mutate(lnF2G = log(F2G_ratio))


# add in F2G ratio to envmatrix (must average nn)
# initiate empty dfs for storing nmds results
alpsppmds <- data.frame()
alpplotmds <- data.frame()
alphulls <- data.frame()
alpells <- data.frame()
# initiate empty list for storing nmds objects, and other stats objects
alpmds <- list()
# initiate empty data frame for storing envfit, permanova, and nmds stress
alpenv <- data.frame()
alpperm <- data.frame()
alpstress <- data.frame()

# iterate through years for multivar analysis
for(i in unique(relstack$tracker)){
  tempmatrix <- subset(relstack, tracker == i) %>%
    dplyr::select(c(colnames(.)[colnames(.) %in% unique(spplist$clean_code2)]))
  # remove any cols that sum to 0 (spp not present in any plot)
  tempmatrix <- tempmatrix[,apply(tempmatrix, 2, sum)>0] 
  # run metamds
  tempmds <- metaMDS(tempmatrix, trymax = 100)
  # scrape results into dfs
  temppoints <- data.frame(tempmds$points) %>%
    rownames_to_column("rowid") %>%
    left_join(envmatrix)
  # make tracker df info
  trackerdf <- distinct(temppoints[c("site", "tracker", "yr", "iter")])
  
  tempspp <- data.frame(tempmds$species) %>%
    rownames_to_column("clean_code2") %>%
    left_join(distinct(spplist[c("clean_code2", "simple_name", "simple_lifeform", "simple_lifeform2")])) %>%
    cbind(trackerdf)
  
  # store nmds ellipse
  ## > note: ordiellipse call throws a warning about invalid graphics state but it's okay, don't care about rendering it in graphics window right now
  #tempord <- ordiellipse(tempmds, temppoints$trt, display = "sites", kind = "se", conf = 0.95, label = T)
  tempell <- data.frame()
  temphulls <- data.frame()
  for(t in unique(temppoints$trt)){
    # ordiellipse for trt t
    tempell <- rbind(tempell, cbind(as.data.frame(with(temppoints[temppoints$trt==t,],
                                                       veganCovEllipse(cov.wt(cbind(MDS1,MDS2),wt=rep(1/length(MDS1),length(MDS1)))$cov,center=c(mean(MDS1),mean(MDS2)))))
                                    ,trt=t, trackerdf))
    # ordihulls for trt t
    trthulls <-rbind(data.frame(temppoints[temppoints$trt == t, ][chull(temppoints[temppoints$trt == t, c("MDS1", "MDS2")]),])) # hull values for grp t
    # append to temphulls
    temphulls <- rbind(temphulls, trthulls)
  }
  
  # bind nmds dat to masters
  alpplotmds <- rbind(alpplotmds, temppoints)
  alpsppmds <- rbind(alpsppmds, tempspp)
  alphulls <- rbind(alphulls, temphulls)
  alpells <- rbind(alpells, tempell)
  # run permanova, betadisper, envfit
  # store list pos
  pos <- which(unique(relstack$tracker) == i)
  ## calculate CB distance
  tempbray <- vegdist(tempmatrix)
  # store all multivar in list
  alpmds[[pos]] <- list(tempmds,
                        envfit(tempmds, temppoints[c("trt", "lnF2G")], perm = 1000),
                        anosim(tempbray, grouping = temppoints$trt, permutations = 1000),
                        mrpp(tempmatrix,  grouping = temppoints$trt, distance = "bray"),
                        adonis(tempmatrix ~ trt * lnF2G, data = temppoints, permutations = 1000, method = "bray"),
                        betadisper(tempbray, temppoints$trt),
                        anova(betadisper(tempbray, temppoints$trt)))
  # assign names
  names(alpmds)[pos] <- paste(unique(temppoints$site), i, sep = "_")
  names(alpmds[[pos]]) <- c("nmds", "envfit", "anosim", "mrpp", "adonis", "betadisper", "anova_disper")
  
  # capture envfit
  for(z in c("vectors", "factors")){
    tempenv <- data.frame(scores(alpmds[[pos]][["envfit"]], display = z)) %>%
      rownames_to_column("met") %>%
      mutate(grp = z, pval = alpmds[[pos]][["envfit"]][[z]]$pvals, 
             r2 = alpmds[[pos]][["envfit"]][[z]]$r) %>%
      cbind(trackerdf)
    alpenv <- rbind(alpenv, tempenv)
  }
  # capture nmds stress, permanova signif
  tempperm <- data.frame(cbind(alpmds[[names(alpmds)[pos]]]$adonis$aov.tab, trackerdf)) %>%
    rownames_to_column("met") %>%
    filter(!is.na(F.Model))
  alpperm <- rbind(alpperm, tempperm)
  alpstress <- rbind(alpstress, data.frame(stress = alpmds[[names(alpmds)[pos]]]$nmds$stress,
                                           tries = alpmds[[names(alpmds)[pos]]]$nmds$tries,
                                           trackerdf))
}

# combine allspp with trait info
alpsppmds <- left_join(alpsppmds, sppscores[c("clean_code2", "resource_grp", "PC1", "PC2")]) %>%
  mutate(resource_grp = ifelse(is.na(resource_grp), "Unknown", resource_grp))

# add signif symbol to stat test dfs for plotting
# envfit -- also add plotting x,y for label if signif
alpenv <- mutate(alpenv, signif = ifelse(pval <= 0.001, "***", ifelse(pval <= 0.01, "**", ifelse(pval <= 0.05, "*", ifelse(pval <= 0.1, ".", "n.s")))),
                 label_x = ifelse(NMDS1 >= 0, NMDS1+0.05, NMDS1-0.05),
                 label_y = ifelse(NMDS2 >= 0, NMDS2+0.05, NMDS2-0.05))

# permanova 
alpperm$signif <- with(alpperm, ifelse(`Pr..F.` <= 0.001, "***", ifelse(`Pr..F.` <= 0.01, "**", ifelse(`Pr..F.` <= 0.05, "*", ifelse(`Pr..F.` <= 0.1, ".", "n.s")))))

# iterate through spp nmds df to extra plotting points for stress
alpstress<- mutate(alpstress, plotx_hi = NA, plotx_lo = NA, ploty_hi = NA, ploty_lo = NA)
for(i in alpstress$tracker){
  alpstress[alpstress$tracker == i, c("plotx_hi", "plotx_lo", "ploty_hi", "ploty_lo")] <- c(
    # choose whichever value is the extreme hi/lo between spp and site ordinations
    max(c(max(alpsppmds$MDS1[alpsppmds$tracker == i]), max(alpplotmds$MDS1[alpplotmds$tracker == i]))),
    min(c(min(alpsppmds$MDS1[alpsppmds$tracker == i]),min(alpplotmds$MDS1[alpplotmds$tracker == i]))),
    max(c(max(alpsppmds$MDS2[alpsppmds$tracker == i]),max(alpplotmds$MDS2[alpplotmds$tracker == i]))),
    min(c(min(alpsppmds$MDS2[alpsppmds$tracker == i]),min(alpplotmds$MDS2[alpplotmds$tracker == i]))))
}

# add envfit info for factors
envfac <- subset(alpenv, grp == "factors") %>%
  as.data.frame() %>%
  dplyr::select(site:signif, pval) %>% distinct() %>%
  rename(env_trt_signif = signif,
         env_pval = pval)
# gather trt signif from permanova
permtrt <- subset(alpperm, met == "trt") %>%
  dplyr::select(site:signif, `Pr..F.`) %>%
  rename(adon_trt_signif = signif,
         adon_trt_pval = `Pr..F.`)

# join to alpstress
alpstress <- left_join(alpstress, envfac) %>% left_join(permtrt)

# clean up environment
rm(tempell, tempenv, temphulls, tempanova, tempperm, temppoints, tempresults, tempspp, tempmatrix, tempmds)

```


```{r main saddle nmds fig, fig.cap = "Fig 4. Saddle dry meadow NMDS, arrayed by year. Species (circle points) colored by PCA resource group. Sites (diamond points), with 95% confidence ellipses shaded, colored by nutrient treatment (n = 4 sites per treatment)."}
sdlnmds <- ggplot(subset(alpplotmds, site == "sdl" & iter == "main"), aes(MDS1, MDS2)) +
  geom_point(aes(fill = trt), size = 1.75, shape = 23, color = "transparent") +
  #geom_polygon(data = sdlhulls, aes(MDS1, MDS2, fill = trt, col = trt), alpha = 0.5) +
  geom_polygon(data=subset(alpells, site == "sdl" & iter == "main"), aes(x=MDS1, y=MDS2,fill=trt), alpha = 0.5) +
  geom_point(data = subset(alpsppmds, site == "sdl" & iter == "main"), aes(MDS1, MDS2, shape = resource_grp, col = resource_grp), fill = "transparent", alpha = 0.8) +
  scale_fill_manual(name = "Treatment", values = trtcols) +
  scale_color_manual(name = "Resource strategy", values = traitcols) +
  scale_shape_manual(name = "Resource strategy", values = c(19, 19, 21)) +
  facet_wrap(~yr, scales = "free") +
  # make legend keys side by side
  theme(#legend.box = "horizontal",
        legend.position = c(0.7, 0.25),
        legend.justification = "left",
        legend.spacing = unit(0, "pt"),
        legend.background = element_blank(),
        panel.grid = element_blank(),
        legend.key.size = unit(9, "pt")) +
  j_theme

if(any(alpenv$pval[alpenv$site == "sdl" & alpenv$grp == "vectors"] <= 0.05)){
  sdlnmds <- sdlnmds + geom_segment(data=subset(alpenv, grp == "vectors" & site == "sdl" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                    arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & site == "sdl" & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
## > to annotate "stress:" paste("Stress:", round(stress,3)))
sdlnmds + geom_text(data = subset(alpstress, site == "sdl"), aes(plotx_hi, ploty_hi, label = round(stress,3)), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, site == "sdl"), aes(plotx_hi, ploty_hi-(plottext/20), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1)

# write out as tiff
ggsave("alpine_addnuts/figures/journal_figs/sdl_nmds.tiff", dpi = 320,
       width = 6, height = 4)
```


```{r sdl multivariate stats for main text, include = F}
# multivariate stats for Saddle dry meadow sites (only plots 1-16 surveyed across all years, n = 4 per treatment group)
## 1997
# test treatment groups and F2G ratio as explanatory factory
alpmds$sdl_main_1997$adonis; alpmds$sdl_main_1997$envfit # trt and F2G signif
alpmds$sdl_main_1997$betadisper; anova(alpmds$sdl_main_1997$betadisper) # marginally statistically signif (P variance different from others)

## 2003
# test treatment groups and F2G ratio as explanatory factory
alpmds$sdl_main_2003$adonis; alpmds$sdl_main_2003$envfit # trt signif in permanova, F2G and trt not signif in envfit
alpmds$sdl_main_2003$betadisper; anova(alpmds$sdl_main_2003$betadisper) # variances not different among groups

## 2005
# test treatment groups and F2G ratio as explanatory factory
alpmds$sdl_main_2005$adonis; alpmds$sdl_main_2005$envfit #trt and F2G signif in both
alpmds$sdl_main_2005$betadisper; anova(alpmds$sdl_main_2005$betadisper) # variance not distinct

## 2012
# test treatment groups and F2G ratio as explanatory factory
alpmds$sdl_main_2012$adonis; alpmds$sdl_main_2012$envfit # trt signif in both, F2G not
alpmds$sdl_main_2012$betadisper; anova(alpmds$sdl_main_2012$betadisper) # variances not distinct

## 2016
# test treatment groups and F2G ratio as explanatory factory
alpmds$sdl_main_2016$adonis; alpmds$sdl_main_2016$envfit # trt and F2G signif in both
# test variances among treatment groups
alpmds$sdl_main_2016$betadisper; anova(alpmds$sdl_main_2016$betadisper) # variances not distinct
```


```{r main nutnet nmds fig, fig.cap = "Fig 5. NutNet dry meadow NMDS, arrayed by year. Species (circle points) colored by PCA resource group. Sites (diamond points), with 95% confidence ellipses shaded, colored by nutrient treatment (n = 4 sites per treatment)."}
nnnmds <- ggplot(subset(alpplotmds, site == "nutnet" & iter == "main"), aes(MDS1, MDS2)) +
  geom_point(aes(fill = trt), size = 1.75, shape = 23, color = "transparent") +
  #geom_polygon(data = sdlhulls, aes(MDS1, MDS2, fill = trt, col = trt), alpha = 0.5) +
  geom_polygon(data=subset(alpells, site == "nutnet" & iter == "main"), aes(x=MDS1, y=MDS2,fill=trt), alpha = 0.5) +
  geom_point(data = subset(alpsppmds, site == "nutnet" & iter == "main"), aes(MDS1, MDS2, col = resource_grp), alpha = 0.75) +
  scale_fill_manual(name = "Treatment", values = trtcols) +
  scale_color_manual(name = "Resource\nstrategy", values = traitcols) +
  facet_wrap(~yr, scales = "free")

# add FG arrows if any significant
if(any(with(alpenv, pval[site == "nutnet" & grepl("main", tracker) & grp == "vectors"]) <= 0.05)){
  nnnmds <- nnnmds + geom_segment(data=subset(alpenv, grp == "vectors" & grepl("main", tracker) & site == "nutnet" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                  arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & site == "nutnet" & grepl("main", tracker) & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
nnnmds + geom_text(data = subset(alpstress, site == "nutnet" & grepl("main", tracker)), aes(plotx_hi, ploty_hi, label = paste("Stress:", round(stress,3))), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, site == "nutnet" & grepl("main", tracker)), aes(plotx_hi, ploty_hi-(plottext/25), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1)

```


```{r nutnet multivariate stats for main text, include = F}
# multivariate stats
## 2013 -- C, N and N+P only (n = 4 per group)
# test treatment groups and F2G ratio as explanatory factory
alpmds$nutnet_main_2013$adonis; alpmds$nutnet_main_2013$envfit # trt signif in permanova, not in envift; F2G signif
alpmds$nutnet_main_2013$betadisper; anova(alpmds$nutnet_main_2013$betadisper) # variances not distinct

## 2017 -- C, N and N+P only (n = 4 per group)
# test treatment groups and F2G ratio as explanatory factory
alpmds$nutnet_main_2017$adonis; alpmds$nutnet_main_2017$envfit # trt signif in permanova but not envfit, F2G signif in both
# test variances among treatment groups
alpmds$nutnet_main_2017$betadisper; anova(alpmds$nutnet_main_2017$betadisper) # variances not distinct
```

### Supplemental multivariate analyses

```{r 2013 nmds with all treatments}
# 2013
nns2013_nmds <- ggplot(subset(alpplotmds, yr == 2013 & iter != "main"), aes(MDS1, MDS2)) +
  geom_point(aes(fill = trt), color = "transparent", size = 1.7, pch = 23) +
  geom_polygon(data=subset(alphulls, yr == 2013 & iter != "main"), aes(MDS1, MDS2, fill = trt), alpha = 0.5) +
  #geom_polygon(data=subset(alpells, yr == 2013 & iter != "main"), aes(x=MDS1, y=MDS2,fill=trt), alpha = 0.5) +
  geom_point(data = subset(alpsppmds, yr == 2013 & iter != "main"), aes(MDS1, MDS2, col = resource_grp), alpha = 0.75) +
  scale_fill_manual(name = "Treatment", values = trtcols) +
  scale_color_manual(name = "Resource\nstrategy", values = traitcols) +
  facet_wrap(~yr)

# add FG arrows if any significant
if(any(with(alpenv, pval[site == "nutnet" & tracker == "suppl_2013" & grp == "vectors"]) <= 0.05)){
  nns2013_nmds <- nns2013_nmds + geom_segment(data=subset(alpenv, grp == "vectors" & tracker == "suppl_2013" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                              arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & tracker == "suppl_2013" & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
nns2013_nmds + geom_text(data = subset(alpstress, site == "nutnet" & tracker == "suppl_2013"), aes(plotx_hi, ploty_hi, label = paste("Stress:", round(stress,3))), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, tracker == "suppl_2013"), aes(plotx_hi, ploty_hi-(plottext/25), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1) +
  labs(caption = "Fig S1. NutNet 2013 NMDS, all treatments (n = 4 per treatment). Treatment hulls drawn for sites.")

```


```{r nutnet 2013 multivariate stats for supplemental text, include = F}
# multivariate stats
## 2013 -- all treatment groups
# test treatment groups and F2G ratio as explanatory factory
alpmds$nutnet_suppl_2013$adonis; alpmds$nutnet_suppl_2013$envfit # trt signif in permanova, not in envift; F2G signif (same in main text results)
alpmds$nutnet_suppl_2013$betadisper; anova(alpmds$nutnet_suppl_2013$betadisper) # variances not distinct (same as in main text results)
```



```{r nn 2017 nmds all trts}
# 2017
nns2017_nmds <- ggplot(subset(alpplotmds, yr == 2017 & iter != "main"), aes(MDS1, MDS2)) +
  geom_polygon(data=subset(alphulls, yr == 2017 & iter != "main"), aes(MDS1, MDS2, fill = trt), alpha = 0.5) +
  #geom_polygon(data=subset(alpells, yr == 2017 & iter != "main"), aes(x=MDS1, y=MDS2,fill=trt), alpha = 0.5) +
  geom_point(aes(fill = trt), pch = 21, color = "transparent", size = 1.7) +
  geom_point(data = subset(alpsppmds, yr == 2017 & iter != "main"), aes(MDS1, MDS2, col = resource_grp), alpha = 0.75) +
  scale_fill_manual(name = "Treatment", values = trtcols) +
  scale_color_manual(name = "Resource\nstrategy", values = traitcols) +
  facet_wrap(~yr)

# add FG arrows if any significant
if(any(with(alpenv, pval[site == "nutnet" & tracker == "suppl_2017" & grp == "vectors"]) <= 0.05)){
  nns2017_nmds <- nns2017_nmds + geom_segment(data=subset(alpenv, grp == "vectors" & tracker == "suppl_2017" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                              arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & tracker == "suppl_2017" & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
nns2017_nmds + geom_text(data = subset(alpstress, site == "nutnet" & tracker == "suppl_2017"), aes(plotx_hi, ploty_hi, label = paste("Stress:", round(stress,3))), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, tracker == "suppl_2017"), aes(plotx_hi, ploty_hi-(plottext/25), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1) +
  labs(caption = "Fig S2. NutNet 2017 NMDS, all treatments (n = 4 per treatment group). Treatment hulls drawn for sites.")

```


```{r nutnet 2017 multivariate stats for supplemental text, include = F}
# multivariate stats
## 2017 -- all treatment groups
# test treatment groups and F2G ratio as explanatory factory
alpmds$nutnet_suppl_2017$adonis; alpmds$nutnet_suppl_2017$envfit # all signif
# test variances among treatment groups
alpmds$nutnet_suppl_2017$betadisper; anova(alpmds$nutnet_suppl_2017$betadisper) # variances not distinct (same as in main text results)
```



```{r table of permanova and betadisper results for main nmds figs}
# pull out trts
suppl13trts <- unique(alphulls$trt[alphulls$tracker == "suppl_2013"])
suppl17trts <- unique(alphulls$trt[alphulls$tracker == "suppl_2017"])
nnmaintrts <- unique(alphulls$trt[alphulls$iter == "main" & alphulls$site == "nutnet"])
sdlmaintrts <- sort(unique(alphulls$trt[alphulls$iter == "main" & alphulls$site == "sdl"]))

permtable <- dplyr::select(alpperm, tracker, site, yr, iter, met, F.Model:`Pr..F.`, signif) %>%
  rename(`Pr.F`= `Pr..F.`) %>%
  mutate(trt = ifelse(site == "sdl", str_flatten(sdlmaintrts, collapse = ", "),
                      ifelse(site == "nutnet" & iter == "main", str_flatten(nnmaintrts, collapse = ", "),
                             ifelse(yr == 2013 & iter == "suppl", str_flatten(suppl13trts, collapse = ", "),
                                    #otherwise will be 2017 suppl
                                    str_flatten(suppl17trts, collapse= ", "))))) %>%
  rename(fig = iter) %>%
  #reorder cols
  dplyr::select(tracker, site, yr, fig, trt, met, R2, F.Model:signif) %>%
  mutate_at(vars(R2, F.Model), function(x)round(x, 3)) %>%
  #R2 = round(R2, 2)) %>%
  unite(F.Stat, F.Model, signif, sep = " ") %>%
  # drop pval
  dplyr::select(-`Pr.F`) %>%
  gather(stat, val, R2, F.Stat) %>%
  unite(cat, met, stat, sep = " ") %>%
  spread(cat, val) %>%
  arrange(desc(site), fig, yr)

# gather betadisper results
alpdisp <- data.frame()
for(i in names(alpmds)){
  tempdisp <- data.frame(alpmds[[i]]$anova_disper) %>%
    rownames_to_column() %>%
    filter(rowname == "Groups") %>%
    mutate(tracker = str_extract(i, "main.*|supp.*"))
  #site = str_extract(i, "^s[a-z]+|^n[a-z]+"),
  #yr = parse_number(i))
  alpdisp <- rbind(alpdisp, tempdisp)
}
# add signif symbols
alpdisp <- rename(alpdisp, pval = "Pr..F.") %>% 
  mutate(signif = ifelse(pval <= 0.001, "***", ifelse(pval <= 0.01, "**", ifelse(pval <= 0.05, "*", ifelse(pval <= 0.1, ".", "n.s")))))
permtable <- left_join(permtable, alpdisp[c("tracker", "F.value", "signif")]) %>%
  mutate(F.value = round(F.value, 3)) %>%
  unite(`dispersion F.stat`, F.value, signif, sep = " ")

kable(permtable, caption = "Table S1. Permutation statistics (permanova and permdisp) for alpine dry meadow communities, iterations = 1000")
```


Marko and Soren's trait dataset overlaps much more with the NutNet/Saddle snowfence fert experiment species list if we allow trait data collected outside Saddle dry meadow sites. Here is the PCA and select NMDS figures remade with alternate resource grouping, along with a table of species and their resource grouping designation derived from dry-meadow only PCA vs. all sites PCA. Whether I select dry meadow only or use trait data from more sites, the resource grouping designation is the same except for 3 species: *Deschampsia cespitosa*, *Tetraneuris grandiflora*, and *Trifolium dasyphyllum*.

```{r alternate PCA fig}
# gather proportional importance
altPCexplain <- data.frame(summary(traitpc_allsites_mostspp)$cont$importance) %>%
  rownames_to_column()
#specify plotting cols for 
traitcols2 <- c(traitcols, Neutral = "coral")

pcfig2 <- ggplot() +
  geom_vline(aes(xintercept = 0), lty = 2, col = "grey") +
  geom_hline(aes(yintercept = 0), lty = 2, col = "grey") +
  geom_segment(data=varscores_mostspp,aes(x=0,xend=PC1,y=0,yend=PC2),
               arrow = arrow(length = unit(0.25, "cm")),colour="grey40") + 
  geom_point(data = sppscores_mostspp, aes(PC1, PC2, col = resource_grp_mostspp2), size = pointsize) +
  geom_text(data = subset(varscores_mostspp, PC1 <=0 & !grepl("D13", abbr)), aes(PC1, PC2, label = abbr), check_overlap = T, hjust = 1, nudge_x = -0.02, size = plottext) +
  # plot D13c separately
  geom_text(data = subset(varscores_mostspp,abbr == "D13C"), aes(PC1, PC2, label = abbr), check_overlap = T, hjust = 0.2, nudge_y = -0.1, size = plottext) +
  geom_text(data = subset(varscores_mostspp, PC1 >0 & !grepl("D15|Chl|Hei", abbr)), aes(PC1, PC2, label = abbr), check_overlap = T, hjust = -0.1, size = plottext) +
  geom_text(data = subset(varscores_mostspp, abbr %in% c("D15N", "Chl")), aes(PC1, PC2, label = abbr), check_overlap = F, vjust = 0, hjust = -0.1, size = plottext) +
  labs(x = paste0("PC1 (",round(altPCexplain$PC1[grepl("^Prop", altPCexplain$rowname)],2)*100, "% variance explained)"),
       y = paste0("PC2 (",round(altPCexplain$PC2[grepl("^Prop", altPCexplain$rowname)],2)*100, "% variance explained)")) +
  # describe axes
  geom_segment(aes(x=0.1,xend=2,y=(min(sppscores_mostspp$PC2)-0.18),yend=(min(sppscores_mostspp$PC2)-0.18)),
               arrow = arrow(length = unit(0.25, "cm")),colour="grey40", alpha = 0.4, lwd = 1) +
  geom_segment(aes(x=-0.1,xend=-1.5,y=(min(sppscores_mostspp$PC2)-0.18),yend=(min(sppscores_mostspp$PC2)-0.18)),
               arrow = arrow(length = unit(0.25, "cm")),colour="grey40", alpha = 0.4, lwd = 1) +
  geom_text(aes(2, (min(sppscores_mostspp$PC2)-0.08), label = "Resource conservative"), fontface = "italic", col = "grey20", size = plottext, hjust = 1) +
  geom_text(aes(-1.5, (min(sppscores_mostspp$PC2)-0.08), label = "Resource acquisitive"), fontface = "italic", col = "grey20", size = plottext, hjust = 0) +
  coord_fixed() +
  scale_color_manual(values = traitcols2, guide = FALSE)
#theme(axis.text = element_text(size = 16),
#  axis.title = element_text(size = 18))

pcfig2 + labs(caption = "Alternate PCA using traits from all sites available in Spasojevic and Weber (2018) to maximize species with resource grouping value")
```



```{r suppl saddle nmds fig with alternate PC resource grp scores}
# join alternate resource designations to spp nmds data frame
alpsppmds2 <- left_join(alpsppmds, sppscores_mostspp[c("clean_code2", "resource_grp_mostspp", "resource_grp_mostspp2", "PC1")], by = "clean_code2") %>%
  mutate(resource_grp_mostspp2 = ifelse(is.na(resource_grp_mostspp2), "Unknown", resource_grp_mostspp2))


sdlnmds2 <- ggplot(subset(alpplotmds, site == "sdl" & iter == "main"), aes(MDS1, MDS2)) +
  geom_point(aes(fill = trt), size = 1.75, shape = 23, color = "transparent") +
  #geom_polygon(data = sdlhulls, aes(MDS1, MDS2, fill = trt, col = trt), alpha = 0.5) +
  geom_polygon(data=subset(alpells, site == "sdl" & iter == "main"), aes(x=MDS1, y=MDS2,fill=trt), alpha = 0.5) +
  geom_point(data = subset(alpsppmds2, site == "sdl" & iter == "main"), aes(MDS1, MDS2, col = resource_grp_mostspp2), alpha = 0.75) +
  scale_fill_manual(name = "Treatment", values = trtcols) +
  scale_color_manual(name = "Resource\nstrategy", values = traitcols2) +
  #scale_color_distiller(palette = "Reds") +
  facet_wrap(~yr, scales = "free") +
  # make legend keys side by side
  theme(legend.box = "horizontal",
        legend.position = c(0.85, 0.3),
        legend.background = element_blank(),
        legend.title = element_text(size = 10))

if(any(alpenv$pval[alpenv$site == "sdl" & alpenv$grp == "vectors"] <= 0.05)){
  sdlnmds2 <- sdlnmds2 + geom_segment(data=subset(alpenv, grp == "vectors" & site == "sdl" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                      arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & site == "sdl" & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
sdlnmds2 + geom_text(data = subset(alpstress, site == "sdl"), aes(plotx_hi, ploty_hi, label = paste("Stress:", round(stress,3))), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, site == "sdl"), aes(plotx_hi, ploty_hi-(plottext/25), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1) +
  labs(caption = "Saddle NMDS main figure with alternate PCA resource grouping for species points. 95% confidence ellpises drawns for treatments.")
```



```{r main nutnet nmds fig with alternate resource grp}
nnnmds2 <- ggplot(subset(alpplotmds, site == "nutnet" & iter == "main"), aes(MDS1, MDS2)) +
  geom_point(aes(col = trt), pch = 8) +
  #geom_polygon(data = sdlhulls, aes(MDS1, MDS2, fill = trt, col = trt), alpha = 0.5) +
  geom_polygon(data=subset(alpells, site == "nutnet" & iter == "main"), aes(x=MDS1, y=MDS2, col=trt), alpha = 0.5, fill = "transparent", lty = 2) +
  geom_point(data = subset(alpsppmds2, site == "nutnet" & iter == "main"), aes(MDS1, MDS2, fill = resource_grp_mostspp2), alpha = 0.75, size = 3, shape = 21, color = "transparent") +
  scale_color_manual(name = "Treatment", values = trtcols) +
  scale_fill_manual(name = "Resource\nstrategy", values = traitcols2) +
  facet_wrap(~yr, scales = "free")

# add FG arrows if any significant
if(any(with(alpenv, pval[site == "nutnet" & grepl("main", tracker) & grp == "vectors"]) <= 0.05)){
  nnnmds2 <- nnnmds2 + geom_segment(data=subset(alpenv, grp == "vectors" & grepl("main", tracker) & site == "nutnet" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                    arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & site == "nutnet" & grepl("main", tracker) & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
nnnmds2 + geom_text(data = subset(alpstress, site == "nutnet" & grepl("main", tracker)), aes(plotx_hi, ploty_hi, label = paste("Stress:", round(stress,3))), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, site == "nutnet" & grepl("main", tracker)), aes(plotx_hi, ploty_hi-(plottext/25), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1) +
  labs(caption = "Nutnet NMDS main figure with alternate PCA resource grouping for species points. 95% confidence ellpises drawns for treatments.")

```




```{r nn 2017 nmds all trts with alternate resource grp}
# 2017
nns2017_nmds2 <- ggplot(subset(alpplotmds, yr == 2017 & iter != "main"), aes(MDS1, MDS2)) +
  geom_polygon(data=subset(alphulls, yr == 2017 & iter != "main"), aes(MDS1, MDS2, col = trt), alpha = 0.5, lty = 2, fill = "transparent") +
  #geom_polygon(data=subset(alpells, yr == 2017 & iter != "main"), aes(x=MDS1, y=MDS2,fill=trt), alpha = 0.5) +
  geom_point(aes(col = trt), pch = 8) +
  geom_point(data = subset(alpsppmds2, yr == 2017 & iter != "main"), aes(MDS1, MDS2, fill = resource_grp_mostspp2), alpha = 0.75,  pch = 21, color = "transparent", size =3) +
  scale_color_manual(name = "Treatment", values = trtcols) +
  scale_fill_manual(name = "Resource\nstrategy", values = traitcols2) +
  facet_wrap(~yr)

# add FG arrows if any significant
if(any(with(alpenv, pval[site == "nutnet" & tracker == "suppl_2017" & grp == "vectors"]) <= 0.05)){
  nns2017_nmds2 <- nns2017_nmds2 + geom_segment(data=subset(alpenv, grp == "vectors" & tracker == "suppl_2017" & pval <= 0.05),aes(x=0,xend=NMDS1,y=0,yend=NMDS2),
                                                arrow = arrow(length = unit(0.25, "cm")),colour="black") + 
    # add label to envfit arrow
    geom_text(data=subset(alpenv, grp == "vectors" & tracker == "suppl_2017" & pval <= 0.05),aes(x=label_x,y=label_y, label = paste0(signif,"F:G")), col = "black", size = plottext, fontface = "italic")
}

# annotate stress and trt signif
nns2017_nmds2 + geom_text(data = subset(alpstress, site == "nutnet" & tracker == "suppl_2017"), aes(plotx_hi, ploty_hi, label = paste("Stress:", round(stress,3))), size = plottext, hjust = 1) +
  geom_text(data = subset(alpstress, tracker == "suppl_2017"), aes(plotx_hi, ploty_hi-(plottext/25), label = paste("Trt", env_trt_signif)), size = plottext, hjust = 1) +
  labs(caption = "NutNet 2017 NMDS supplemental figure, with alternate PCA resource grouping. Treatment hulls drawn for sites.")
```


```{r print table of resource grouping}
kable(dplyr::select(alpsppmds2, clean_code2, simple_name, simple_lifeform2, resource_grp, resource_grp_mostspp, resource_grp_mostspp2) %>%
        filter(resource_grp_mostspp2 != "Unknown") %>%
        rename(`DM-only group`= resource_grp,
               `All sites grp1` = resource_grp_mostspp,
               `All sites grp2` = resource_grp_mostspp2) %>%
        arrange(`All sites grp2`, simple_name) %>%
        distinct(),
      caption = "Species resource grouping designations based on PCA (dry meadow-only traits vs all sites traits)")
```

